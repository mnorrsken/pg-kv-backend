{{- if and .Values.redis.password.create (not .Values.redis.password.existingSecret.name) }}
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ include "postkeys.fullname" . }}-secret-generator
  labels:
    {{- include "postkeys.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "-10"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ include "postkeys.fullname" . }}-secret-generator
  labels:
    {{- include "postkeys.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "-10"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "create", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: {{ include "postkeys.fullname" . }}-secret-generator
  labels:
    {{- include "postkeys.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "-10"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: {{ include "postkeys.fullname" . }}-secret-generator
subjects:
  - kind: ServiceAccount
    name: {{ include "postkeys.fullname" . }}-secret-generator
    namespace: {{ .Release.Namespace }}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "postkeys.fullname" . }}-generate-redis-secret
  labels:
    {{- include "postkeys.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "-5"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  ttlSecondsAfterFinished: 60
  template:
    metadata:
      labels:
        {{- include "postkeys.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: secret-generator
    spec:
      serviceAccountName: {{ include "postkeys.fullname" . }}-secret-generator
      restartPolicy: Never
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000
      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
        - name: generate-secret
          image: "{{ .Values.redis.password.secretGenerator.image.repository }}:{{ .Values.redis.password.secretGenerator.image.tag }}"
          imagePullPolicy: {{ .Values.redis.password.secretGenerator.image.pullPolicy }}
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - ALL
          command:
            - /bin/sh
            - -c
            - |
              set -e
              SECRET_NAME="{{ include "postkeys.redisSecretName" . }}"
              SECRET_KEY="{{ .Values.redis.password.existingSecret.key | default "redis-password" }}"
              NAMESPACE="{{ .Release.Namespace }}"
              
              # Check if secret already exists
              if kubectl get secret "$SECRET_NAME" -n "$NAMESPACE" >/dev/null 2>&1; then
                echo "Secret $SECRET_NAME already exists, skipping creation"
                exit 0
              fi
              
              # Generate a random 32-character password
              PASSWORD=$(head -c 32 /dev/urandom | base64 | tr -dc 'a-zA-Z0-9' | head -c 32)
              
              # Create the secret
              kubectl create secret generic "$SECRET_NAME" \
                --namespace "$NAMESPACE" \
                --from-literal="$SECRET_KEY=$PASSWORD"
              
              # Add labels to the secret
              kubectl label secret "$SECRET_NAME" \
                --namespace "$NAMESPACE" \
                app.kubernetes.io/name={{ include "postkeys.name" . }} \
                app.kubernetes.io/instance={{ .Release.Name }} \
                app.kubernetes.io/managed-by={{ .Release.Service }}
              
              echo "Successfully created secret $SECRET_NAME"
{{- end }}
